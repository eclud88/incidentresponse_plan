{% extends 'base.html' %}
{% block title %}Response Plan{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card-custom p-4">
            <h2 class="mb-2 text-center fw-bold" style="letter-spacing: 0.15em;">Incident Response Plan</h2>
            {% set evidences_map = evidences %}
            {% set substeps_map = sub_steps %}

            {% if class_ and type_ %}
            <div class="mb-4 text-center">
                <h5 class="fw-semibold text-muted">
                    Class: <span class="text-primary">{{ class_ }}</span> &nbsp;|&nbsp;
                    Type: <span class="text-primary">{{ type_ }}</span>
                </h5>
            </div>
            {% endif %}

            <ul class="nav nav-tabs justify-content-center" id="stepsTab" role="tablist">
                {% for step in steps %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link {% if loop.first %}active{% endif %}"
                            id="tab-{{ loop.index }}"
                            data-bs-toggle="tab"
                            data-bs-target="#step-{{ loop.index }}"
                            type="button"
                            role="tab"
                            aria-controls="step-{{ loop.index }}"
                            aria-selected="{{ 'true' if loop.first else 'false' }}"
                            {% if not loop.first %}disabled{% endif %}>
                        Step {{ loop.index }}
                    </button>
                </li>
                {% endfor %}
            </ul>

            <div class="tab-content mt-4" id="stepsTabContent">
                {% for step in steps %}
                {% set step_index = loop.index %}
                <div class="tab-pane fade {% if loop.first %}show active{% endif %}"
                     id="step-{{ step_index }}"
                     role="tabpanel"
                     aria-labelledby="tab-{{ step_index }}">

                    <p class="fw-bold fs-5 border-start border-4 border-primary ps-3 mb-3">
                        {{ step.step }}
                    </p>

                    {% if step.sub_steps %}
                    <div class="mb-4 ms-3">
                        <p class="fw-semibold text-muted mb-2">Sub-Steps Checklist<span class="text-danger">*</span>:</p>
                        <div class="list-group">
                            {% for sub in step.sub_steps %}
                            <label class="list-group-item d-flex align-items-center gap-2 border rounded shadow-sm px-3 py-2 mb-2 hover-effect custom-checkbox-label">
                                <input class="form-check-input mt-0 substep-checkbox"
                                       type="checkbox"
                                       id="step-{{ step_index }}-substep-{{ sub | replace(' ', '-') }}"
                                       value="{{ sub }}"
                                       data-step-index="{{ step_index }}"
                                       {% if sub_steps_data and step_index|string in sub_steps_data and sub in sub_steps_data[step_index|string] %}checked{% endif %}>

                                <span class="substep-text fw-medium">{{ sub }}</span>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <div class="mb-3">
                        <label for="evidence-{{ step_index }}" class="form-label fw-semibold">Evidence(s)<span class="text-danger">*</span>:</label>
                        <textarea id="evidence-{{ step_index }}" class="form-control" rows="4" required aria-required="true"
                                  placeholder="Describe logs, actions taken, screenshots, tools used, findings, or communications. This information will be included in the incident report.">{{ evidences[step_index|string] if evidences and step_index|string in evidences else '' }}</textarea>
                    </div>

                    <div class="mb-4">
                        <label for="file-{{ loop.index }}" class="form-label fw-semibold">Attach File<span class="text-danger">*</span>:</label>
                        <input type="file" class="form-control" id="file-{{ loop.index }}" onchange="updateIncident({{ loop.index }})">

                        {% set key = loop.index|string %}
                        {% set file_path = existing_files[key] if key in existing_files else None %}


                        {% if file_path %}
                        <div id="file-status-{{ loop.index }}" class="small mt-1 text-success">
                            ‚úÖ Ficheiro j√° carregado: <a href="/{{ file_path }}" target="_blank">{{ file_path.split('/')[-1] }}</a>
                        </div>
                        {% else %}
                        <div id="file-status-{{ loop.index }}" class="small mt-1 text-danger">
                        </div>
                        {% endif %}
                    </div>


                    <div class="d-flex justify-content-between align-items-center mt-4">
                        {% if not loop.first %}
                        <button class="btn btn-secondary" onclick="goBackStep({{ step_index }})">‚Üê Previous</button>
                        {% else %}
                        <span></span>
                        {% endif %}

                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-success btn-sm" onclick="saveStep({{ step_index }})">üíæ Save</button>
                            <span id="feedback-{{ step_index }}" class="text-muted small"></span>

                            {% if not loop.last %}
                            <button class="btn btn-success" id="btn-next-{{ step_index }}" onclick="nextStep({{ step_index }})" disabled>Next ‚Üí</button>
                            {% else %}
                            <button class="btn btn-purple" id="btn-finish" onclick="finishPlan()" disabled>‚úÖ Finish Plan</button>
                            {% endif %}

                        </div>
                    </div>

                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
    const uploadStatus = {};

    // Dados vindos do backend
    const savedEvidences = {{ evidences|default({}, true)|tojson }};
    const savedSubSteps = {{ sub_steps|default({}, true)|tojson }};
    const existingFiles = {{ existing_files|default({}, true)|safe }};
    const percent = Number({{ percent|default(0.0)|tojson|safe }});

    function isUploadDone(index) {
        return uploadStatus[index] === true;
    }

    function validateStepInputs(index) {
        const evidence = document.getElementById(`evidence-${index}`).value.trim();
        const checkedSubsteps = Array.from(
            document.querySelectorAll(`#step-${index} .substep-checkbox:checked`)
        );
        const uploadDone = isUploadDone(index);
        return evidence.length > 0 && checkedSubsteps.length > 0 && uploadDone;
    }

    function updateNextButton(index) {
        const nextButton = document.getElementById(`btn-next-${index}`);
        if (!nextButton) return;
        if (validateStepInputs(index)) {
            nextButton.disabled = false;
            nextButton.classList.remove('btn-secondary');
            nextButton.classList.add('btn-success');
        } else {
            nextButton.disabled = true;
            nextButton.classList.remove('btn-success');
            nextButton.classList.add('btn-secondary');
        }
    }

    function saveStep(index) {
    const checkedSubsteps = Array.from(
        document.querySelectorAll(`#step-${index} .substep-checkbox:checked`)
    ).map(cb => cb.value);
    const evidence = document.getElementById(`evidence-${index}`).value.trim();

    fetch("/incident/save_step", {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({
            step: index,
            evidence: evidence,
            checked_substeps: checkedSubsteps
        })
    })
    .then(res => res.json())
    .then(data => {
        const feedback = document.getElementById(`feedback-${index}`);
        if (data.status === 'ok') {
            feedback.textContent = "‚úÖ Saved successfully";
            feedback.classList.remove("text-danger");
            feedback.classList.add("text-success");
        } else {
            feedback.textContent = "‚ùå Error saving";
            feedback.classList.remove("text-success");
            feedback.classList.add("text-danger");
        }
        setTimeout(() => feedback.textContent = '', 4000);

        checkProgress(); // <--- ADICIONADO AQUI
    })
    .catch(err => {
        console.error("Erro t√©cnico ao gravar step:", err);
        const feedback = document.getElementById(`feedback-${index}`);
        feedback.textContent = "Technical error.";
        feedback.classList.add("text-danger");
    });
}


   function updateIncident(index) {
    const fileInput = document.getElementById(`file-${index}`);
    const file = fileInput?.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('file', file);
    formData.append('step', index);

    fetch('/incident/upload_file', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        const statusElem = document.getElementById(`file-status-${index}`);
        if (data.status === 'success') {
            statusElem.textContent = "‚úÖ File uploaded successfully";
            statusElem.classList.remove('text-danger');
            statusElem.classList.add('text-success');
            uploadStatus[index] = true;
        } else {
            statusElem.textContent = "‚ùå Upload failed";
            statusElem.classList.remove('text-success');
            statusElem.classList.add('text-danger');
            uploadStatus[index] = false;
        }
        updateNextButton(index);

        checkProgress();
    })
    .catch(error => {
        const statusElem = document.getElementById(`file-status-${index}`);
        statusElem.textContent = "‚ùå Upload error";
        statusElem.classList.remove('text-success');
        statusElem.classList.add('text-danger');
        uploadStatus[index] = false;
        updateNextButton(index);
        console.error('Error uploading file:', error);
    });
}

    function nextStep(currentIndex) {
        const nextIndex = currentIndex + 1;
        const nextTabButton = document.getElementById(`tab-${nextIndex}`);
        if (!nextTabButton) return;
        nextTabButton.removeAttribute("disabled");
        const tab = new bootstrap.Tab(nextTabButton);
        tab.show();
    }

    function goBackStep(currentIndex) {
        const previousIndex = currentIndex - 1;
        const prevTabButton = document.getElementById(`tab-${previousIndex}`);
        if (!prevTabButton) return;
        prevTabButton.removeAttribute("disabled");
        const tab = new bootstrap.Tab(prevTabButton);
        tab.show();
    }

    function finishPlan() {
        const lastStepIndex = document.querySelectorAll('.tab-pane').length;

        const checkedSubsteps = Array.from(
            document.querySelectorAll(`#step-${lastStepIndex} .substep-checkbox:checked`)
        ).map(cb => cb.value);
        const evidence = document.getElementById(`evidence-${lastStepIndex}`).value.trim();

        fetch("/incident/save_step", {
            method: "POST",
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
                step: lastStepIndex,
                evidence: evidence,
                checked_substeps: checkedSubsteps
            })
        })
            .then(res => res.json())
            .then(data => {
                console.log("Resposta do save_step:", data);
                if (data.status === 'ok') {
                    if (data.percent === 50.0) {
                        const finishBtn = document.getElementById('btn-finish');
                        if (finishBtn) finishBtn.removeAttribute('disabled');
                        window.location.href = "/incident/complete";
                    } else {
                        alert("‚ùå Ainda h√° passos incompletos. Verifique antes de finalizar.");
                    }
                } else {
                    alert("‚ùå Erro ao guardar o √∫ltimo passo.");
                }
            })
            .catch(err => {
                console.error("Erro t√©cnico ao finalizar o plano:", err);
                alert("‚ùå Erro t√©cnico ao finalizar o plano.");
            });
    }

    function allStepsValid(totalSteps) {
        for (let i = 1; i < totalSteps; i++) {
            if (!validateStepInputs(i)) {
                return false;
            }
        }
        return true;
    }

    document.addEventListener('DOMContentLoaded', () => {
        const totalSteps = document.querySelectorAll('.tab-pane').length;
        let allComplete = true;

        for (let i = 1; i < totalSteps; i++) {
            // Restaurar estado de ficheiro
            const fileStatusElem = document.getElementById(`file-status-${i}`);
            const existingPath = existingFiles[i.toString()];
            if (existingPath) {
                uploadStatus[i] = true;
                const fileName = existingPath.split('/').pop();
                fileStatusElem.innerHTML = `‚úÖ Ficheiro existente: <a href="/${existingPath}" target="_blank">${fileName}</a>`;
                fileStatusElem.classList.remove('text-danger');
                fileStatusElem.classList.add('text-success');
            } else {
                uploadStatus[i] = false;
                fileStatusElem.textContent = "‚ùå Nenhum ficheiro";
                fileStatusElem.classList.remove('text-success');
                fileStatusElem.classList.add('text-danger');
            }

            // Restaurar texto e checkboxes
            const textarea = document.getElementById(`evidence-${i}`);
            if (textarea && savedEvidences[i]) {
                textarea.value = savedEvidences[i];
            }

            const checkboxes = document.querySelectorAll(`#step-${i} .substep-checkbox`);
            checkboxes.forEach(cb => {
                if (savedSubSteps[i]?.includes(cb.value)) {
                    cb.checked = true;
                }
                cb.addEventListener('change', () => updateNextButton(i));
            });

            textarea?.addEventListener('input', () => updateNextButton(i));

            // Atualizar bot√£o Next
            updateNextButton(i);

            if (!validateStepInputs(i)) {
                allComplete = false;

                const nextTabButton = document.getElementById(`tab-${i}`);
                if (nextTabButton) {
                    nextTabButton.removeAttribute('disabled');
                    const tab = new bootstrap.Tab(nextTabButton);
                    tab.show();
                }
                break; // parar no primeiro incompleto
            }
        }
    });

    function checkProgress() {
        fetch('/incident/save_step', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({})
        })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'ok' && data.percent === 50.0) {
                    const finishBtn = document.getElementById('btn-finish');
                    if (finishBtn) finishBtn.removeAttribute('disabled');
                }else {
                    // bot√£o permanece disabled
                    const finishBtn = document.getElementById('btn-finish');
                    if (finishBtn) finishBtn.setAttribute('disabled', true);
                }
            })
            .catch(err => {
                console.error(err);
            });
    }

    document.addEventListener('DOMContentLoaded', () => {
        checkProgress();
    });


</script>

{% endblock %}
