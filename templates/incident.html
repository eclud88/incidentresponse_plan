{% extends 'base.html' %}

{% block title %}Incidents{% endblock %}

{% block content %}

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card-custom p-4 shadow rounded-4 bg-white">
            <h3 class="mb-4 text-center">Incident Report</h3>

            <form action="/incident/steps" method="POST">
                <!-- Class Selection -->
                <div class="mb-3">
                    <label for="class" class="form-label">Incident Class</label>
                    <select name="class" id="class" class="form-select rounded-pill" onchange="updateTypes()" required>
                        <option value="">Select</option>
                        {% for incident in incidentes %}
                            <option value="{{ incident.classe }}" {% if incident.classe == classe %}selected{% endif %}>
                                {{ incident.classe }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Type Selection -->
                <div class="mb-3">
                    <label for="type" class="form-label">Incident Type</label>
                    <select name="type" id="type" class="form-select rounded-pill" required>
                        <option value="">Select a class first</option>
                    </select>
                </div>

                <div class="d-grid">
                    <button type="submit" class="btn btn-purple rounded-pill">Submit</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Script -->
<script>
    function toggleDropdown() {
        document.getElementById("dropdown-content").classList.toggle("show");
    }

    window.addEventListener('click', function(event) {
        if (!event.target.matches('.user-button')) {
            const dropdowns = document.querySelectorAll(".dropdown-content");
            dropdowns.forEach(d => d.classList.remove("show"));
        }
    });

    const incidents = {{ incidentes | tojson }};
    const currentClass = "{{ classe | default('') }}";
    const currentType = "{{ tipo | default('') }}";

    function updateTypes() {
        const selectedClass = document.getElementById("class").value;
        const typeSelect = document.getElementById("type");

        typeSelect.innerHTML = '<option value="">Select a type</option>';

        const foundClass = incidents.find(inc => inc.classe === selectedClass);
        if (foundClass) {
            foundClass.tipos.forEach(type => {
                const typeName = typeof type === 'string' ? type : type.tipo;
                const option = document.createElement("option");
                option.value = typeName;
                option.textContent = typeName;
                if (typeName === currentType) {
                    option.selected = true;
                }
                typeSelect.appendChild(option);
            });
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        if (currentClass) {
            document.getElementById("class").value = currentClass;
            updateTypes();
        }
    });
</script>
{% endblock %}

