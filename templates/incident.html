{% extends 'base.html' %}

{% block title %}Incidents{% endblock %}

{% block content %}
<style>
  body {
    background-color: #f5f6fa;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #333;
  }

  h3 {
    color: #6b00c2;
    font-weight: 600;
    text-align: center;
    margin-bottom: 25px;
  }

  .card-custom {
    background-color: white;
    border-radius: 16px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    padding: 30px;
  }

  .form-label {
    font-weight: 500;
    color: #555;
  }

  .form-select,
  .btn {
    border-radius: 50px !important;
    padding: 10px 18px;
    font-size: 15px;
  }

  .form-select:focus,
  .btn:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(138, 0, 194, 0.2);
    border-color: #8a00c2;
  }

  .btn-purple {
    background-color: #8a00c2;
    color: white;
    font-weight: bold;
    transition: background-color 0.3s;
  }

  .btn-purple:hover {
    background-color: #6b00a8;
  }

  .form-text {
    color: #777;
    font-size: 13px;
    margin-top: 4px;
  }

  .user-dropdown {
    position: absolute;
    top: 20px;
    right: 20px;
    z-index: 1000;
  }

  .user-button {
    background-color: #3498db;
    color: white;
    padding: 10px 16px;
    font-size: 14px;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
  }

  .user-button:hover {
    background-color: #2980b9;
  }

  .dropdown-content {
    display: none;
    position: absolute;
    right: 0;
    background-color: white;
    min-width: 120px;
    box-shadow: 0px 8px 16px rgba(0,0,0,0.2);
    border-radius: 6px;
    overflow: hidden;
    z-index: 1000;
  }

  .dropdown-content a {
    color: black;
    padding: 10px 12px;
    text-decoration: none;
    display: block;
  }

  .dropdown-content a:hover {
    background-color: #f1f1f1;
  }

  .show {
    display: block;
  }
</style>

{% if show_user_dropdown %}
<div class="user-dropdown">
  <button class="user-button" onclick="toggleDropdown()">
    {{ session['username'] }} âŒ„
  </button>
  <div id="dropdown-content" class="dropdown-content">
    <a href="{{ url_for('logout') }}">Logout</a>
  </div>
</div>
{% endif %}

<div class="row justify-content-center">
  <div class="col-md-8">
    <div class="card-custom">
      <h3>Incident Report</h3>

      <form action="/incident/steps" method="POST" id="incidentForm" novalidate>
        <!-- Incident Class -->
        <div class="mb-3">
          <label for="class" class="form-label">Incident Class</label>
          <select name="class" id="class" class="form-select" aria-describedby="classHelp" required>
            <option value="" disabled selected>Select</option>
            {% for incident in incidents %}
            <option value="{{ incident.class }}" {% if incident.class == class %}selected{% endif %}>{{ incident.class }}</option>
            {% endfor %}
          </select>
          <div id="classHelp" class="form-text">Choose first the class of incident.</div>
        </div>

        <!-- Incident Type -->
        <div class="mb-3">
          <label for="type" class="form-label">Incident Type</label>
          <select name="type" id="type" class="form-select" aria-describedby="typeHelp" required disabled>
            <option value="">Select a class first</option>
          </select>
          <div id="typeHelp" class="form-text">Select the type based on the class.</div>
        </div>

        <div class="d-grid">
          <button type="submit" class="btn btn-purple" disabled id="submitBtn">Submit</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const incidents = {{ incidents | tojson }};
  const currentClass = "{{ class | default('') }}";
  const currentType = "{{ type | default('') }}";

  const classSelect = document.getElementById('class');
  const typeSelect = document.getElementById('type');
  const submitBtn = document.getElementById('submitBtn');

  function updateTypes() {
    const selectedClass = classSelect.value;
    typeSelect.innerHTML = '';
    typeSelect.disabled = true;

    if (!selectedClass) {
      typeSelect.innerHTML = '<option value="">Select a class first</option>';
      updateSubmitButton();
      return;
    }

    const foundClass = incidents.find(inc => inc.class === selectedClass);
    if (foundClass && foundClass.types && foundClass.types.length > 0) {
      typeSelect.disabled = false;
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = 'Select a type';
      defaultOption.disabled = true;
      defaultOption.selected = true;
      typeSelect.appendChild(defaultOption);

      foundClass.types.forEach(type => {
        const typeName = (typeof type === 'string') ? type : type.type;
        const option = document.createElement('option');
        option.value = typeName;
        option.textContent = typeName;
        if (typeName === currentType) {
          option.selected = true;
        }
        typeSelect.appendChild(option);
      });
    } else {
      typeSelect.innerHTML = '<option value="">No types available</option>';
    }
    updateSubmitButton();
  }

  function updateSubmitButton() {
    submitBtn.disabled = !(classSelect.value && typeSelect.value);
  }

  classSelect.addEventListener('change', () => {
    updateTypes();
    updateSubmitButton();
  });

  typeSelect.addEventListener('change', updateSubmitButton);

  document.addEventListener('DOMContentLoaded', () => {
    if (currentClass) {
      classSelect.value = currentClass;
      updateTypes();
      if (currentType) {
        typeSelect.value = currentType;
      }
    } else {
      typeSelect.innerHTML = '<option value="">Select a class first</option>';
      typeSelect.disabled = true;
    }
    updateSubmitButton();
  });

  function toggleDropdown() {
    document.getElementById("dropdown-content").classList.toggle("show");
  }

  window.addEventListener('click', function(event) {
    if (!event.target.matches('.user-button')) {
      const dropdowns = document.querySelectorAll(".dropdown-content");
      dropdowns.forEach(d => d.classList.remove("show"));
    }
  });
</script>
{% endblock %}



