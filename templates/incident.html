{% extends 'base.html' %}

{% block title %}Incidents{% endblock %}

{% block content %}
<style>
  body {
    background-color: #f5f6fa;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #333;
  }

  h3 {
    color: #6b00c2;
    font-weight: 600;
    text-align: center;
    margin-bottom: 25px;
  }

  .card-custom {
    background-color: white;
    border-radius: 16px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    padding: 30px;
  }

  .form-label {
    font-weight: 500;
    color: #555;
  }

  .form-select,
  .btn {
    border-radius: 50px !important;
    padding: 10px 18px;
    font-size: 15px;
  }

  .form-select:focus,
  .btn:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(138, 0, 194, 0.2);
    border-color: #8a00c2;
  }

  .btn-purple {
    background-color: #8a00c2;
    color: white;
    font-weight: bold;
    transition: background-color 0.3s;
  }

  .btn-purple:hover {
    background-color: #6b00a8;
  }

  .form-text {
    color: #777;
    font-size: 13px;
    margin-top: 4px;
  }

  .user-menu {
    position: absolute;
    top: 20px;
    right: 30px;
    z-index: 1000;
    font-family: 'Inter', sans-serif;
  }

  .user-toggle {
    background-color: #6b00c2;
    color: white;
    padding: 10px 16px;
    border: none;
    border-radius: 30px;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    transition: background-color 0.3s ease;
  }

  .user-toggle:hover {
    background-color: #58009f;
  }

  .user-dropdown-content {
    display: none;
    position: absolute;
    right: 0;
    background-color: white;
    min-width: 140px;
    box-shadow: 0px 8px 16px rgba(0,0,0,0.2);
    border-radius: 8px;
    overflow: hidden;
    z-index: 1001;
    margin-top: 5px;
  }

  .user-dropdown-content a {
    color: black;
    padding: 10px 14px;
    text-decoration: none;
    display: block;
    font-size: 14px;
  }

  .user-dropdown-content a:hover {
    background-color: #f1f1f1;
  }

  .show {
    display: block;
  }
</style>

{% if show_user_dropdown %}
<div class="user-menu">
  <button class="user-toggle" onclick="toggleDropdown()">
    <span class="user-name">{{ session['username'] }}</span>
    <span class="chevron">â–¾</span>
  </button>
  <div id="dropdown-content" class="user-dropdown-content">
    <a href="{{ url_for('logout') }}">ðŸšª Logout</a>
  </div>
</div>
{% endif %}

<div class="row justify-content-center">
  <div class="col-md-8">
    <div class="card-custom">
      <h3>Incident Report</h3>

      <form action="{{ url_for('incident') }}" method="POST" id="incidentForm" novalidate>
        <!-- Incident Class -->
        <div class="mb-3">
          <label for="class" class="form-label">Incident Class</label>
          <select name="class" id="class" class="form-select" aria-describedby="classHelp" required>
            <option value="" disabled {% if not class_ %}selected{% endif %}>Select here a class</option>
            {% for incident in incidents %}
            <option value="{{ incident.class }}" {% if class_ is defined and incident.class == class_ %}selected{% endif %}>{{ incident.class }}</option>

            {% endfor %}
          </select>
          <div id="classHelp" class="form-text">Choose first the incident class.</div>
        </div>

        <!-- Incident Type -->
        <div class="mb-3">
          <label for="type" class="form-label">Incident Type</label>
          <select name="type" id="type" class="form-select" aria-describedby="typeHelp" required disabled>
            <option value="">Select a class first</option>
          </select>
          <div id="typeHelp" class="form-text">Select the type based on the class.</div>
        </div>

        <div class="d-grid">
          <button type="submit" class="btn btn-purple" id="submitBtn" disabled>Submit</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  const incidents = {{ incidents | tojson }};
  const currentClass = "{{ class_ | default('') }}";
  const currentType = "{{ type_ | default('') }}";

  const classSelect = document.getElementById('class');
  const typeSelect = document.getElementById('type');
  const submitBtn = document.getElementById('submitBtn');

  function updateSubmitButton() {
    submitBtn.disabled = !(classSelect.value && typeSelect.value);
  }

  function updateTypes() {
    const selectedClass = classSelect.value;
    typeSelect.innerHTML = '';
    typeSelect.disabled = true;

    if (!selectedClass) {
      typeSelect.innerHTML = '<option value="">Select a class first</option>';
      updateSubmitButton();
      return;
    }

    const foundClass = incidents.find(inc => inc.class === selectedClass);

    if (!foundClass || !foundClass.types || foundClass.types.length === 0) {
      typeSelect.innerHTML = '<option value="">No types available</option>';
      updateSubmitButton();
      return;
    }

    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = 'Select a type';
    defaultOption.disabled = true;
    defaultOption.selected = true;
    typeSelect.appendChild(defaultOption);

    foundClass.types.forEach(type => {
      const typeName = typeof type === 'string' ? type : type.type;
      const option = document.createElement('option');
      option.value = typeName;
      option.textContent = typeName;

      typeSelect.appendChild(option);
    });

    typeSelect.disabled = false;
    updateSubmitButton();
  }

  classSelect.addEventListener('change', () => {
    updateTypes();
    updateSubmitButton();
  });

  typeSelect.addEventListener('change', updateSubmitButton);

  document.addEventListener('DOMContentLoaded', () => {
    updateSubmitButton();
  });

  function toggleDropdown() {
    console.log("aaaa");
    document.getElementById("dropdown-content").classList.toggle("show");
  }

  window.addEventListener('click', function(event) {
    if (!event.target.closest('.user-toggle')) {
      document.getElementById("dropdown-content").classList.remove("show");
    }
  });
</script>
{% endblock %}


