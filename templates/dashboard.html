{% extends 'base.html' %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<h1 class="mb-2">D A S H B O A R D</h1>

<div class="d-flex justify-content-end my-3">
  <a href="{{ url_for('incident') }}" class="btn btn-success">
    ➕ New Record
  </a>
</div>

{% if in_progress_incidents %}
  <h4>⏳ In Progress</h4>
  <table class="table table-warning table-hover align-middle">
    <thead>
      <tr>
        <th>ID</th>
        <th>Description</th>
        <th>Start Date</th>
        <th>% Completed</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% for incident in in_progress_incidents %}
      <tr>
        <td>{{ incident.id }}</td>
        <td>{{ incident.class_param }} - {{ incident.type_param }}</td>
        <td>{{ incident.start_date.strftime('%d/%m/%Y') }}</td>
        <td>{{ incident.progress_percentage() }}%</td>
        <td>
          <a href="{{ url_for('resume_incident', incident_id=incident.id) }}" class="btn btn-sm btn-outline-primary">
            ▶️ Resume
          </a>
          <div class="progress mt-2" style="height: 5px;">
            <div class="progress-bar bg-success"
                role="progressbar"
                style="width: {{ incident.progress_percentage() }}%;"
                aria-valuenow="{{ incident.progress_percentage() }}"
                aria-valuemin="0" aria-valuemax="100"></div>
          </div>
          <small>{{ incident.progress_percentage() }}% done</small>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
{% endif %}

{% if incidents %}
<h4>✅ Completed Incidents</h4>
<table class="table table-striped table-hover align-middle">
  <thead class="table-dark">
    <tr>
      <th>ID</th>
      <th>Description</th>
      <th>Start Date</th>
      <th>End Date</th>
      <th>Status</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody>
    {% for incident in incidents %}
    <tr>
      <td>{{ incident.id }}</td>
      <td>{{ incident.name }}</td>
      <td>{{ incident.start_date.strftime('%d/%m/%Y') if incident.start_date else '' }}</td>
      <td>{{ incident.end_date.strftime('%d/%m/%Y') if incident.end_date else '—' }}</td>
      <td>
        <span class="badge bg-secondary">{{ incident.status }}</span>
      </td>
      <td>
        <button class="btn btn-sm btn-outline-danger btn-delete btn-delete-focus" data-id="{{ incident.id }}" title="Delete incident {{ incident.id }}" aria-label="Delete incident {{ incident.id }}">
          🗑️
        </button>
        ||
        <button class="btn btn-sm btn-outline-success btn-download btn-download-focus"
                data-id="{{ incident.id }}"
                title="Download report for incident {{ incident.id }}"
                aria-label="Download report for incident {{ incident.id }}">
          📄
        </button>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
<div class="alert alert-info text-center" role="alert">
  No incident records found. Click <strong>+ New Record</strong> to add your first one.
</div>
{% endif %}

<script>
  document.addEventListener('DOMContentLoaded', () => {
    let idToDelete = null;
    const modalElement = document.getElementById('confirmModal');
    const confirmModal = new bootstrap.Modal(modalElement);

    // Utilitário para obter o CSRF token
    function getCookie(name) {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + '=')) {
          return decodeURIComponent(cookie.substring(name.length + 1));
        }
      }
      return null;
    }

    // Exclusão de incidentes
    document.querySelectorAll('.btn-delete').forEach(btn => {
      btn.addEventListener('click', () => {
        idToDelete = btn.dataset.id;
        confirmModal.show();
      });
    });

    document.getElementById('btnYes').addEventListener('click', () => {
      if (!idToDelete) return;

      fetch(`/delete_incident/${idToDelete}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrf_token')
        }
      }).then(response => {
        if (response.ok) {
          location.reload();
        } else {
          alert('❌ Error deleting the record.');
        }
      }).catch(() => {
        alert('❌ Communication error with the server.');
      });

      confirmModal.hide();
      idToDelete = null;
    });

    document.getElementById('btnNo').addEventListener('click', () => {
      confirmModal.hide();
      idToDelete = null;
    });

    // Função para tratar o clique no botão de download
    async function handleDownload(button) {
      const incidentId = button.dataset.id;

      try {
        const headResponse = await fetch(`/incident/${incidentId}/download`, { method: 'HEAD' });

        if (!headResponse.ok) {
          alert(`⚠️ Report file not found for incident ${incidentId}`);
          button.disabled = true;
          button.classList.remove('btn-outline-success');
          button.classList.add('btn-secondary');
          return;
        }

        const link = document.createElement('a');
        link.href = `/incident/${incidentId}/download`;
        link.download = '';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } catch (err) {
        console.error("Download failed", err);
        alert("⚠️ An error occurred while attempting to download the report.");
      }
    }

    // Inicializar os botões de download
    document.querySelectorAll('.btn-download').forEach(button => {
      button.addEventListener('click', () => handleDownload(button));
    });
  });
</script>
{% endblock %}