{% extends 'base.html' %}
{% block title %}Plano de Resposta{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-md-10">
    <div class="card-custom p-4">
      <h3 class="mb-3 text-center">Plano de Resposta a Incidente</h3>

      {% if classe and tipo %}
      <div class="mb-4 text-center">
        <h5>
          Classe do Incidente: {{ classe }}<br>
          Tipo de Incidente: {{ tipo }}
        </h5>
      </div>
      {% endif %}

      <!-- Abas -->
      <ul class="nav nav-tabs" id="passosTab" role="tablist">
        {% for passo in passos %}
        <li class="nav-item" role="presentation">
          <button class="nav-link {% if loop.first %}active{% endif %}"
                  id="tab-{{ loop.index0 }}"
                  data-bs-toggle="tab"
                  data-bs-target="#passo-{{ loop.index0 }}"
                  type="button"
                  role="tab"
                  aria-controls="passo-{{ loop.index0 }}"
                  aria-selected="{{ 'true' if loop.first else 'false' }}">
            Passo {{ loop.index }}
          </button>
        </li>
        {% endfor %}
        <li class="nav-item" role="presentation">
          <button class="nav-link"
                  id="tab-licoes"
                  data-bs-toggle="tab"
                  data-bs-target="#passo-licoes"
                  type="button"
                  role="tab"
                  aria-controls="passo-licoes"
                  aria-selected="false">
            Lições Aprendidas
          </button>
        </li>
      </ul>

      <!-- Conteúdo das abas -->
      <div class="tab-content mt-3" id="passosTabContent">
        {% for passo in passos %}
        <div class="tab-pane fade {% if loop.first %}show active{% endif %}"
             id="passo-{{ loop.index0 }}"
             role="tabpanel"
             aria-labelledby="tab-{{ loop.index0 }}">

          <p class="fw-semibold">{{ passo }}</p>

          <label for="evidencia-{{ loop.index0 }}" class="form-label">Evidência(s):</label>
          <textarea id="evidencia-{{ loop.index0 }}" class="form-control mb-3" rows="4"
                    placeholder="Descreva a(s) evidência(s)..." required></textarea>

          <label for="ficheiro-{{ loop.index0 }}" class="form-label">Anexar Ficheiro:</label>
          <input type="file" class="form-control mb-3" id="ficheiro-{{ loop.index0 }}"
                 onchange="atualizarIncidente({{ loop.index0 }})">

          <div class="d-flex justify-content-between mt-4">
            {% if not loop.first %}
            <button class="btn btn-secondary" onclick="voltarPasso({{ loop.index0 }})">Passo Anterior</button>
            {% else %}
            <span></span>
            {% endif %}

            {% if not loop.last %}
            <button class="btn btn-purple" onclick="avancarPasso({{ loop.index0 }})">Próximo Passo</button>
            {% else %}
            <button class="btn btn-purple" onclick="mostrarLicoes()">Próximo Passo</button>
            {% endif %}
          </div>
        </div>
        {% endfor %}

        <!-- Abas: Lições Aprendidas -->
        <div class="tab-pane fade" id="passo-licoes" role="tabpanel" aria-labelledby="tab-licoes">

          <label for="melhorias" class="form-label mt-3">Melhorias a implementar:</label>
          <textarea id="melhorias" class="form-control mb-3" rows="4"
                    placeholder="Descreva as melhorias sugeridas..." required></textarea>

          <label for="observacoes" class="form-label">Observações Finais:</label>
          <textarea id="observacoes" class="form-control mb-3" rows="4"
                    placeholder="Outras observações relevantes..." required></textarea>

          <div class="d-flex justify-content-between mt-4">
            <button class="btn btn-secondary" onclick="voltarPasso('licoes')">Passo Anterior</button>
            <button class="btn btn-purple" id="btn-finalizar" onclick="finalizarPlano()" disabled>Finalizar Plano</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script>
  function atualizarIncidente(indice) {
    console.log(`Ficheiro atualizado no passo ${indice}`);
  }

  async function avancarPasso(indiceAtual) {
    const textarea = document.getElementById(`evidencia-${indiceAtual}`);
    if (!textarea.value.trim()) {
      alert('Por favor, preencha a evidência antes de continuar.');
      textarea.focus();
      return;
    }

    try {
      await fetch("/incident/salvar_passo", {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          passo: indiceAtual,
          evidencia: textarea.value.trim()
        })
      });

      const abaAtualTab = document.getElementById(`tab-${indiceAtual}`);
      abaAtualTab.classList.add('bg-success', 'text-white');

      const proximoBotao = document.getElementById(`tab-${indiceAtual + 1}`);
      if (proximoBotao) {
        new bootstrap.Tab(proximoBotao).show();
      }
    } catch (err) {
      alert('Erro ao guardar o passo. Tente novamente.');
    }
  }

  function mostrarLicoes() {
    const ultimoIndice = {{ passos|length - 1 }};
    const ultimaAba = document.getElementById(`tab-${ultimoIndice}`);
    if (ultimaAba) {
      ultimaAba.classList.add('bg-success', 'text-white');
    }

    const tabLicoes = document.getElementById("tab-licoes");
    if (tabLicoes) {
      new bootstrap.Tab(tabLicoes).show();
    }
  }

  function voltarPasso(indiceAtual) {
    let anteriorBotao;

    if (indiceAtual === 'licoes' || indiceAtual === {{ passos|length }}) {
      anteriorBotao = document.getElementById(`tab-{{ passos|length - 1 }}`);
    } else {
      anteriorBotao = document.getElementById(`tab-${indiceAtual - 1}`);
    }

    if (anteriorBotao) {
      new bootstrap.Tab(anteriorBotao).show();
    }
  }

  function finalizarPlano() {
    const melhorias = document.getElementById("melhorias").value.trim();
    const observacoes = document.getElementById("observacoes").value.trim();

    if (!melhorias || !observacoes) {
      alert("Por favor, preencha todos os campos antes de finalizar.");
      return;
    }

    fetch('/salvar_finalizacao', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ melhorias, observacoes })
    }).then(() => {
      window.location.href = "/incident/finalizar";
    }).catch(() => {
      alert("Erro ao salvar as lições aprendidas.");
    });
  }

  // Ativa o botão "Finalizar" somente se os campos forem preenchidos
  document.addEventListener('DOMContentLoaded', function () {
    const melhoriasInput = document.getElementById("melhorias");
    const observacoesInput = document.getElementById("observacoes");
    const btnFinalizar = document.getElementById("btn-finalizar");

    function verificarCampos() {
      btnFinalizar.disabled = !(melhoriasInput.value.trim() && observacoesInput.value.trim());
    }

    melhoriasInput.addEventListener('input', verificarCampos);
    observacoesInput.addEventListener('input', verificarCampos);
  });
</script>
{% endblock %}



