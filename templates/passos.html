{% extends 'base.html' %}
{% block title %}Response Plan{% endblock %}

{% block content %}

<style>
.user-dropdown {
    position: absolute;
    top: 20px;
    right: 20px;
    z-index: 1000;
}

.user-button {
    background-color: #3498db;
    color: white;
    padding: 10px 16px;
    font-size: 14px;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

.user-button:hover {
    background-color: #2980b9;
}

.dropdown-content {
    display: none;
    position: absolute;
    right: 0;
    background-color: white;
    min-width: 120px;
    box-shadow: 0px 8px 16px rgba(0,0,0,0.2);
    border-radius: 6px;
    overflow: hidden;
}

.dropdown-content a {
    color: black;
    padding: 10px 12px;
    text-decoration: none;
    display: block;
}

.dropdown-content a:hover {
    background-color: #f1f1f1;
}

.show {
    display: block;
}
</style>

<div class="row justify-content-center">
  <div class="col-md-10">
    <div class="card-custom p-4">
      <h3 class="mb-3 text-center">Incident Response Plan</h3>

      {% if classe and tipo %}
      <div class="mb-4 text-center">
        <h5>
          Incident Class: {{ classe }}<br>
          Incident Type: {{ tipo }}
        </h5>
      </div>
      {% endif %}

      <!-- Tabs -->
      <ul class="nav nav-tabs" id="stepsTab" role="tablist">
        {% for passo in passos %}
        <li class="nav-item" role="presentation">
          <button class="nav-link {% if loop.first %}active{% endif %}"
                  id="tab-{{ loop.index0 }}"
                  data-bs-toggle="tab"
                  data-bs-target="#step-{{ loop.index0 }}"
                  type="button"
                  role="tab"
                  aria-controls="step-{{ loop.index0 }}"
                  aria-selected="{{ 'true' if loop.first else 'false' }}">
            Step {{ loop.index }}
          </button>
        </li>
        {% endfor %}
      </ul>

      <!-- Tab Content -->
      <div class="tab-content mt-3" id="stepsTabContent">
        {% for passo in passos %}
        <div class="tab-pane fade {% if loop.first %}show active{% endif %}"
             id="step-{{ loop.index0 }}"
             role="tabpanel"
             aria-labelledby="tab-{{ loop.index0 }}">

          <p class="fw-semibold">{{ passo }}</p>

          <label for="evidence-{{ loop.index0 }}" class="form-label">Evidence(s):</label>
          <textarea id="evidence-{{ loop.index0 }}" class="form-control mb-3" rows="4"
                    placeholder="Describe the evidence(s)..." required></textarea>

          <label for="file-{{ loop.index0 }}" class="form-label">Attach File:</label>
          <input type="file" class="form-control mb-3" id="file-{{ loop.index0 }}"
                 onchange="updateIncident({{ loop.index0 }})">

          <div class="d-flex justify-content-between mt-4">
            {% if not loop.first %}
            <button class="btn btn-secondary" onclick="goBackStep({{ loop.index0 }})">Previous Step</button>
            {% else %}
            <span></span>
            {% endif %}

            {% if not loop.last %}
            <button class="btn btn-secondary" id="btn-next-{{ loop.index0 }}"
                    onclick="nextStep({{ loop.index0 }})" disabled>Next Step</button>
            {% else %}
            <button class="btn btn-purple" id="btn-finish" onclick="finishPlan()" disabled>Finish Plan</button>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script>
function toggleDropdown() {
    document.getElementById("dropdown-content").classList.toggle("show");
}

window.addEventListener('click', function(event) {
    if (!event.target.matches('.user-button')) {
        const dropdowns = document.querySelectorAll(".dropdown-content");
        dropdowns.forEach(d => d.classList.remove("show"));
    }
});

function updateIncident(index) {
    console.log(`File updated in step ${index}`);
}

async function nextStep(currentIndex) {
    const textarea = document.getElementById(`evidence-${currentIndex}`);
    if (!textarea.value.trim()) {
        alert('Please fill in the evidence before continuing.');
        textarea.focus();
        return;
    }

    try {
        await fetch("/incident/save_step", {
            method: "POST",
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                step: currentIndex,
                evidence: textarea.value.trim()
            })
        });

        const currentTab = document.getElementById(`tab-${currentIndex}`);
        currentTab.classList.add('bg-success', 'text-white');

        const nextButton = document.getElementById(`tab-${currentIndex + 1}`);
        if (nextButton) {
            new bootstrap.Tab(nextButton).show();
        }
    } catch (err) {
        alert('Error saving the step. Please try again.');
    }
}

function goBackStep(currentIndex) {
    const previousButton = document.getElementById(`tab-${currentIndex - 1}`);
    if (previousButton) {
        new bootstrap.Tab(previousButton).show();
    }
}

function finishPlan() {
    const lastIndex = {{ passos|length - 1 }};
    const textarea = document.getElementById(`evidence-${lastIndex}`);

    if (!textarea.value.trim()) {
        alert('Please fill in the evidence for the last step before finishing.');
        textarea.focus();
        return;
    }

    fetch('/incident/save_step', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            step: lastIndex,
            evidence: textarea.value.trim()
        })
    }).then(() => {
        // Redirect to final page (with improvements and feedback)
        window.location.href = "/incident/finish";
    }).catch(() => {
        alert("Error finishing the plan.");
    });
}

document.addEventListener('DOMContentLoaded', function () {
    const totalSteps = {{ passos|length }};
    for (let i = 0; i < totalSteps; i++) {
        const textarea = document.getElementById(`evidence-${i}`);

        // "Next Step" buttons
        if (i < totalSteps - 1) {
            const nextButton = document.getElementById(`btn-next-${i}`);

            function checkField() {
                if (textarea.value.trim()) {
                    nextButton.disabled = false;
                    nextButton.classList.remove('btn-secondary');
                    nextButton.classList.add('btn-success');
                } else {
                    nextButton.disabled = true;
                    nextButton.classList.remove('btn-success');
                    nextButton.classList.add('btn-secondary');
                }
            }

            textarea.addEventListener('input', checkField);
            checkField();
        }

        // "Finish Plan" button
        if (i === totalSteps - 1) {
            const finishButton = document.getElementById("btn-finish");

            function checkLastField() {
                finishButton.disabled = !textarea.value.trim();
            }

            textarea.addEventListener('input', checkLastField);
            checkLastField();
        }
    }
});
</script>
{% endblock %}
